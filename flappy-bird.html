<!DOCTYPE html>
<meta charset="utf-8" />

<style type="text/css">
  .player {
    fill: red;
  }

  .game {
    background-color: grey;
  }
</style>
<body></body>
<script src="./node_modules/d3/dist/d3.min.js"></script>
<script>
  // const margin = { top: 50, right: 50, bottom: 50, left: 50 };
  const width = 1000;
  const height = 600;

  const svg = d3
    .select("body")
    .append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("class", "game")
    .append("g");

  setInterval(createAndTransitionPipePair, 800);
  createPlayer();
  function createPlayer() {
    const player = svg
      .append("rect")
      .attr("class", "player")
      .attr("x", 20)
      .attr("y", 300)
      .attr("width", 20)
      .attr("height", 20);
    makePlayerFall(player);

    let isKeyDown = false;
    document.body.onkeydown = function(e) {
      if (e.keyCode == 32 && !isKeyDown) {
        isKeyDown = true;
        const playerJumped = player
          .transition()
          .duration(100)
          .attr("y", parseFloat(player.attr("y")) - 50)
          .transition()
          .duration(Math.sqrt(700 - player.attr("y")) * 50)
          .attr("y", 700)
          .ease(d3.easeQuadIn);
        // makePlayerFall(playerJumped); Doesn't work????????
      }
    };

    document.body.onkeyup = function(e) {
      if (e.keyCode == 32) {
        isKeyDown = false;
      }
    };
  }

  function createAndTransitionPipePair() {
    const shift = d3.randomUniform(-150, 150)(); // TODO make it so that the tiles can vary more but stay close to most recent value
    [-400 + shift, 400 + shift].forEach(y => {
      svg
        .append("rect")
        .attr("x", width)
        .attr("y", y)
        .attr("width", 20)
        .attr("height", 600)
        .transition()
        .duration(2000)
        .ease(d3.easeLinear)
        .attr("x", -30)
        .remove();
    });
  }
  function makePlayerFall(play) {
    play
      .transition()
      .duration(Math.sqrt(600 - play.attr("y")) * 50)
      .attr("y", 600)
      .ease(d3.easeQuadIn);
  }
</script>
